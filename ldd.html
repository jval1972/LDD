<!DOCTYPE html>
<html>
<body>

<h2>JavaScript Functions</h2>

<p>This example calls a function which performs a calculation and returns the result:</p>

<p id="demo"></p>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.5.0/jszip.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jszip-utils/0.1.0/jszip-utils.min.js"></script>
<script>

class Matrix3D{

	constructor(n11=1,n12=0,n13=0,n14=0,n21=0,n22=1,n23=0,n24=0,n31=0,n32=0,n33=1,n34=0,n41=0,n42=0,n43=0,n44=1){
		this.n11 = n11
		this.n12 = n12
		this.n13 = n13
		this.n14 = n14
		this.n21 = n21
		this.n22 = n22
		this.n23 = n23
		this.n24 = n24
		this.n31 = n31
		this.n32 = n32
		this.n33 = n33
		this.n34 = n34
		this.n41 = n41
		this.n42 = n42
		this.n43 = n43
		this.n44 = n44
	}

}

class DBinfo {
	//done
	constructor(data) {
		var parser = new DOMParser();
		var xml = parser.parseFromString(data, "text/xml");
		var Version = xml.getElementsByTagName('Bricks')[0].attributes['version'].value
		console.log('DB Version: ' + Version);
		return ('DB Version: ' + Version);
	}
}


class Converter {
	
	LoadDBURL(dbURLlocation){
		this.database = new DBURLReader(dbURLlocation)
		if(this.database.initok && this.database.fileexist('Materials.xml') && this.database.fileexist('localizedStrings.loc')){
			this.allMaterials = new Materials(this.database.filelist['Materials.xml'].read())
			this.allMaterials.setLOC(new LOCReader(this.database.filelist['localizedStrings.loc'].read()))
		}
	}
	
	LoadScene(filename){
		if(this.database.initok){
			this.scene = new Scene(filename)
		}
	}
}


class LOCReader {
	//done
	constructor(data) {
		this.offset = 0
		this.values = {}
		this.data = data
		if (this.data[0].charCodeAt() == 50 && this.data[1].charCodeAt() == 0){
			
			this.offset += 2
			while (this.offset < this.data.length){
				var key = this.NextString().replace('Material', '')
				var value = this.NextString()
				this.values[key] = value
			}
		}
	}
	
	NextString(){
		var out =''
		var t = this.data[this.offset].charCodeAt()
		this.offset += 1
		while (t != 0){
			out = out + String.fromCharCode(t)
			t = this.data[this.offset].charCodeAt()
			this.offset += 1
		}
		return out;
	}
}

class Group{
	//done
	constructor(node){
		this.partRefs =  node.getAttribute('partRefs').split(',')
	}
}

class Bone{
	//done
	constructor(node){
		this.refID = node.getAttribute('refID')
		let [a, b, c, d, e, f, g, h, i, x, y, z] = node.getAttribute('transformation').split(',').map(parseFloat);
		this.matrix = new Matrix3D(a,b,c,0,d,e,f,0,g,h,i,0,x,y,z,1);
	}
}


class Part{
	//done
	constructor(node){
		this.isGrouped = false
		this.GroupIDX = 0
		this.Bones = []
		this.refID = node.getAttribute('refID')
		this.designID = node.getAttribute('designID')
		this.materials =  node.getAttribute('materials').split(',')
		
		var lastm = '0'
		for (const [i, m] of this.materials.entries()) {
			if (m == '0'){
				this.materials[i] = lastm
			}
			else {
				lastm = m
			}
		}

		if (node.hasAttribute('decoration')){
			this.decoration = node.getAttribute('decoration').split(',')
		}
		var childnodes = node.childNodes
		for (var j = 0; j < childnodes.length ;j++) {
			var childnode = childnodes[j]
			if (childnode.nodeName == 'Bone'){
				this.Bones.push(new Bone(childnode))
			}
		}
	}
}


class Brick{
	//done
	constructor(node){
		this.refID = node.getAttribute('refID')
		this.designID = node.getAttribute('designID')
		this.Parts = []
		var childnodes = node.childNodes
		for (var j = 0; j < childnodes.length ;j++) {
			var childnode = childnodes[j]
			if (childnode.nodeName == 'Part'){
				this.Parts.push(new Part(childnode))
			}
		}
	}
}

class SceneCamera{
	//done
	constructor(node){
		this.refID = node.getAttribute('refID')
		let [a, b, c, d, e, f, g, h, i, x, y, z] = node.getAttribute('transformation').split(',').map(parseFloat);
		this.matrix = new Matrix3D(a,b,c,0,d,e,f,0,g,h,i,0,x,y,z,1);
		this.fieldOfView = parseFloat(node.getAttribute('fieldOfView'));
		this.distance = parseFloat(node.getAttribute('distance'));
	}
}


class Scene{
	constructor(file){
		this.Bricks = []
		this.Scenecamera = []
		this.Groups = []
		var xmldata =''
		if (file.endsWith('.lxfml')){
			var lxfmlfile = new DBURLFile(file,file)
			xmldata = lxfmlfile.read()
		}
		else if (file.endsWith('.lxf')){
			alert('IMAGE100.LXFML')
			
			var promise = new JSZip.external.Promise(function (resolve, reject) {
				JSZipUtils.getBinaryContent(file, function(err, data) {
					if (err) {
						reject(err);
					} else {
						resolve(data);
					}
				});
			});

			promise.then(JSZip.loadAsync)                     // 2) chain with the zip promise
			.then(function(zip) {
				return zip.file("IMAGE100.LXFML").async("string"); // 3) chain with the text content promise
			})
			.then(function success(text) {                    // 4) display the result
				
				xmldata = text
				console.log(xmldata)
				
				
				
			}, function error(e) {
				console.log(e)
			});
		}
		else {
			return
		}
		
		var parser = new DOMParser();
		var xml = parser.parseFromString(xmldata, "text/xml");
		this.Name = xml.firstChild.getAttribute('name')
		console.log(this.Name)
		
		var nodes = xml.firstChild.childNodes;
		for (var i = 0; i < nodes.length ;i++) {
			var node = nodes[i]
			if (node.nodeName == 'Meta'){
				var childnodes = node.childNodes
				for (var j = 0; j < childnodes.length ;j++) {
					var childnode = childnodes[j]
					if (childnode.nodeName == 'BrickSet'){
						this.Version = childnode.getAttribute('version')
					}
				}
			}
			else if (node.nodeName == 'Cameras'){
				var childnodes = node.childNodes
				for (var j = 0; j < childnodes.length ;j++) {
					var childnode = childnodes[j]
					if (childnode.nodeName == 'Camera'){
						this.Scenecamera.push(new SceneCamera(childnode))
					}
				}
			}
			else if (node.nodeName == 'Bricks'){
				var childnodes = node.childNodes
				for (var j = 0; j < childnodes.length ;j++) {
					var childnode = childnodes[j]
					if (childnode.nodeName == 'Brick'){
						this.Bricks.push(new Brick(childnode))
					}
				}
			}
			else if (node.nodeName == 'GroupSystems'){
				var childnodes = node.childNodes
				for (var j = 0; j < childnodes.length ;j++) {
					var childnode = childnodes[j]
					if (childnode.nodeName == 'GroupSystem'){
						var subchildnodes = childnode.childNodes
						for (var k = 0; k < subchildnodes.length ;k++) {
							var subchildnode = subchildnodes[k]
							if (subchildnode.nodeName == 'Group'){
								this.Groups.push(new Group(subchildnode))
								console.log(this.Groups)
							}
						}
					}
				}
			}
			
			for (const [i, m] of this.Groups.entries()) {
				for (const brick of this.Bricks){
					for (const part of brick.Parts){
						console.log(part.refID)
						if (part.refID == '0') {
						
						}
					}
				}
			}
			
			
		}

	
	}
}

class Materials {
	constructor(data) {
		this.Materials = {}
		var parser = new DOMParser();
		var xml = parser.parseFromString(data,"text/xml");
		
		var nodes = xml.firstChild.childNodes;
		for (var i = 0; i < nodes.length ;i++) {
			var node = nodes[i]
			if (node.nodeName == 'Material') {
				this.Materials[node.getAttribute('MatID')] = new Material(node.getAttribute('MatID'), parseInt(node.getAttribute('Red')), parseInt(node.getAttribute('Green')), parseInt(node.getAttribute('Red')), parseInt(node.getAttribute('Blue')), parseInt(node.getAttribute('Alpha')), node.getAttribute('MaterialType'))
			}
			
		}
	}
	
	setLOC(loc){
		for (var key in loc.values){
			if (key in this.Materials){
				this.Materials[key].name = loc.values[key].replace(" ", "_")
			}
		}
	}
	
	getMaterialbyId(mid) {
		return this.Materials[mid]
	}

}


class Material {
	constructor(id, r, g, b, a, mtype) {
		this.id = id
		this.name = ''
		this.mattype = mtype
		this.r = parseFloat(r)
		this.g = parseFloat(g)
		this.b = parseFloat(b)
		this.a = parseFloat(a)
	}

	string(){
		out = ('Red: ' + this.r + ' Green: ' + this.g + ' Blue: '+ this.b + ' Aplha: ' + this.a)
		return out;
	}
}


function FindDBURL(){
	var dburl = 'https://api.github.com/repos/sttng/LDD-DB/contents/'
	let xhr = new XMLHttpRequest();
	xhr.open('GET', dburl, false);  // `false` makes the request synchronous
	xhr.setRequestHeader("Authorization", "token 0c8d5b77e090e3ddaefc24a708aec7eb90a1293c");

	// request state change event
	xhr.onreadystatechange = function() {
		
		// request completed?
		if (xhr.readyState !== 4) {//return;
			dburl = false;
			console.log('readyState error in FindDBURL:', xhr.status, xhr.statusText);
		}
		if (xhr.status === 200) {
			// request successful - show response
			//console.log(xhr.responseText);
		}
		else {
			// request error
			dburl = false;
			console.log('HTTP error in FindDBURL:', xhr.status, xhr.statusText);
		}
	};
	
	// start request
	xhr.send();
	return dburl
}

class DBURLFile {
	constructor(urlHandle, name) {
		this.urlHandle = urlHandle
		this.name = name
	}

	read() {
		var fileContent
		var self = this;
		let xhr = new XMLHttpRequest();
		xhr.open('GET', self.urlHandle, false);
		
			// request state change event
		xhr.onreadystatechange = function() {
			
			// request completed?
			if (xhr.readyState !== 4) {//return;
				console.log('readyState error in DBURLFile:', xhr.status, xhr.statusText);
			}
			if (xhr.status === 200) {
				// request successful - show response
				fileContent = xhr.responseText;
			}
			else {
				// request error
				console.log('HTTP error in DBURLFile:', xhr.status, xhr.statusText);
			}
		};
		
		// start request
		xhr.send();
		return fileContent
	}
}


class DBURLReader {
	constructor(dburl) {
		this.filelist = {};
		this.initok = false;
		this.location = dburl;
		this.dbinfo = '';
		this.parse(this.location);
		
		// console.log(JSON.stringify(this.filelist))
		
		if(this.fileexist('Materials.xml') && this.fileexist('info.xml')){
			this.dbinfo = new DBinfo(this.filelist['info.xml'].read());
			this.initok = true
		}
		else{
			alert("db url ERROR")
		}
	}
	
	fileexist(filename) {
		var self = this;
		return self.filelist[filename];
	}
	
	parse(dburl) {
		var self = this;
		let xhr = new XMLHttpRequest();
		xhr.open('GET', dburl, false);
		xhr.setRequestHeader("Authorization", "token 0c8d5b77e090e3ddaefc24a708aec7eb90a1293c");
		
		// request state change event
		xhr.onreadystatechange = function() {
			
			// request completed?
			if (xhr.readyState !== 4) return;
		
			if (xhr.status === 200) {
				// request successful - show response
				var data = JSON.parse(xhr.responseText)
				//console.log(JSON.stringify(data, null, "\t"));
				for(var i = 0; i < data.length; i++) {
						var obj = data[i];
						if(obj.type=="dir") { //for a dir with call the function again with the URL of the dir.
							self.parse(obj.url)
						}
						else if (obj.type=="file") { //for a file we add its name and url to our filelist dict.
							self.filelist[obj.name] = new DBURLFile(obj.download_url, obj.download_url);
						}
						else { //we have objects whose type is neither file nor dir. This should be strange but we ignore
							console.log('strange obj');
						}
					}
			}
			else {
				// request error
				console.log('HTTP error', xhr.status, xhr.statusText);
			}
		};
		
		// start request
		xhr.send();
		return dburl
	}
}


//Start
if (FindDBURL()) {
	converter = new Converter()
	converter.LoadDBURL(dbURLlocation = FindDBURL())
	converter.LoadScene(filename = "https://raw.githubusercontent.com/sttng/LDD/master/test01.lxfml")
	
}
else {
	alert("LDD database not available. Please look for LEGO-Digital-Designer database.")
}










</script>

</body>
</html>
