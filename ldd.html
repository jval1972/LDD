<!DOCTYPE html>
<html>
<body>

<h2>JavaScript Functions</h2>

<p>This example calls a function which performs a calculation and returns the result:</p>

<p id="demo"></p>

<script>

class Converter {
	
	LoadDBURL(dbURLlocation){
		var dbreader = new DBURLReader(dbURLlocation)
		//this.database = dbreader
		alert('Here' + dbURLlocation)
		
	}
	
}


class Materials {
	
	constructor(data) {
		this.Materials = {}
		parser = new DOMParser();
		xml = parser.parseFromString(data,"text/xml");
		for (node in xml.firstChild.childNodes) {
			if (node.nodeName == 'Material') {
				self.Materials[node.getAttribute('MatID')] = Material(node.getAttribute('MatID'),r=int(node.getAttribute('Red')), g=int(node.getAttribute('Green')), b=int(node.getAttribute('Blue')), a=int(node.getAttribute('Alpha')), mtype=str(node.getAttribute('MaterialType')))
			}
		}

	}

}

function FindDBURL(){
	var dburl = 'https://api.github.com/repos/sttng/LDD-DB/contents/?access_token=0c8d5b77e090e3ddaefc24a708aec7eb90a1293c'
	let xhr = new XMLHttpRequest();
	xhr.open('GET', dburl, false);  // `false` makes the request synchronous

	// request state change event
	xhr.onreadystatechange = function() {
		
		// request completed?
		if (xhr.readyState !== 4) {//return;
			dburl = false;
			console.log('readyState error in FindDBURL:', xhr.status, xhr.statusText);
		}
		if (xhr.status === 200) {
			// request successful - show response
			//console.log(xhr.responseText);
		}
		else {
			// request error
			dburl = false;
			console.log('HTTP error in FindDBURL:', xhr.status, xhr.statusText);
		}
	};
	
	// start request
	xhr.send();
	return dburl
}

class DBURLFile {

	constructor(urlHandle, name) {
		this.urlHandle = urlHandle
		this.name = name
	}

	read() {
		var fileContent
		var self = this;
		let xhr = new XMLHttpRequest();
		xhr.open('GET', self.urlHandle, false);
		
			// request state change event
		xhr.onreadystatechange = function() {
			
			// request completed?
			if (xhr.readyState !== 4) {//return;
				console.log('readyState error in DBURLFile:', xhr.status, xhr.statusText);
			}
			if (xhr.status === 200) {
				// request successful - show response
				fileContent = xhr.responseText;
				console.log(fileContent);
				
			}
			else {
				// request error
				console.log('HTTP error in DBURLFile:', xhr.status, xhr.statusText);
			}
		};
		
		// start request
		xhr.send();
		return fileContent
	}
}

class DBURLReader {
	
	constructor(dburl) {
		this.filelist = {};
		this.initok = false;
		this.location = dburl;
		this.dbinfo = '';
		this.parse(this.location);
		// console.log(JSON.stringify(this.filelist))
		
		if(this.fileexist('Materials.xml') && this.fileexist('info.xml')){
			var mu = this.filelist['info.xml'].read()
			var test = new DBinfo(mu)
			alert('mumu')
		}
	}
	
	fileexist(filename) {
		var self = this;
		return self.filelist[filename];
	}
	
	parse(dburl) {
		var self = this;
		let xhr = new XMLHttpRequest();
		xhr.open('GET', dburl, false);
		
		// request state change event
		xhr.onreadystatechange = function() {
			
			// request completed?
			if (xhr.readyState !== 4) return;
		
			if (xhr.status === 200) {
				// request successful - show response
				var data = JSON.parse(xhr.responseText)
				//console.log(JSON.stringify(data, null, "\t"));
				for(var i = 0; i < data.length; i++) {
						var obj = data[i];
						if(obj.type=="dir") { //for a dir with call the function again with the URL of the dir.
							self.parse(obj.url + '&?access_token=0c8d5b77e090e3ddaefc24a708aec7eb90a1293c')
						}
						else if (obj.type=="file") { //for a file we add its name and url to our filelist dict.
							self.filelist[obj.name] = new DBURLFile(obj.download_url, obj.download_url);
						}
						else { //we have objects whose type is neither file nor dir. This should be strange but we ignore
							console.log('strange obj');
						}
					}
			}
			else {
				// request error
				console.log('HTTP error', xhr.status, xhr.statusText);
			}
		};
		
		// start request
		xhr.send();
		return dburl
	}
}



//Start
if (FindDBURL()) {
	converter = new Converter()
	converter.LoadDBURL(dbURLlocation = FindDBURL())
	
}
else {
	alert("LDD database not available. Please look for LEGO-Digital-Designer database.")
}






function parse2(dburl){
	let xhr = new XMLHttpRequest();
	xhr.open('GET', dburl);
	
	// request state change event
	xhr.onreadystatechange = function() {
		
		// request completed?
		if (xhr.readyState !== 4) return;
	
		if (xhr.status === 200) {
			// request successful - show response
			//console.log(xhr.responseText);
			var data = JSON.parse(xhr.responseText)
			for(var i = 0; i < data.length; i++) {
					var obj = data[i];
					if(obj.type=="dir") { //for a dir with call the function again with the URL of the dir.
						//alert(obj.url)
						parse2(obj.url)
					}
					else if (obj.type=="file") { //for a file we add its name and url to our filelist dict.
						filelist[obj.name] = obj.download_url;
					}
					else { //we have objects whose type is neither file nor dir. This should be strange but we ignore
						console.log('strange obj');
					}
				}
		}
		else {
			// request error
			console.log('HTTP error', xhr.status, xhr.statusText);
		}
	};
	
	// start request
	xhr.send();
	return dburl
}








async function parseURL(url) {
	(async () => {
		try {
			var response = await fetch(url);
			var data = await response.json();
			//console.log(data);
			for(var i = 0; i < data.length; i++) {
				var obj = data[i];
				if(obj.type=="dir") { //for a dir with call the function again with the URL of the dir.
					parseURL(obj.url)
				}
				else if (obj.type=="file") { //for a file we add its name and url to our filelist dict.
					filelist[obj.name] = obj.download_url;
				}
				else { //we have objects whose type is neither file nor dir. This should be strange but we ignore
					console.log('strange obj');
				}
			}
			
		} catch (e) {
			console.log('parseURL Problem');
		}
	})();
}



class DBinfo {
	constructor(data) {
		parser = new DOMParser();
		this.xml = parser.parseFromString(data, "text/xml");
		this.Version = xml.getElementsByTagName('Bricks')[0].attributes['version'].value
		console.log(this.Version);
	}
}











</script>

</body>
</html>
